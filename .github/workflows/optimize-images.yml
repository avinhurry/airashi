name: Optimize images

on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - "assets/images/**/*.jpg"
      - "assets/images/**/*.jpeg"
      - "assets/images/**/*.png"
      - "assets/images/**/*.webp"
      - "assets/images/**/*.heic"
      - "assets/images/**/*.heif"

concurrency:
  group: optimize-images
  cancel-in-progress: true

permissions:
  contents: write

jobs:
  optimize:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Convert HEIC to JPEG (and update references)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y libheif-examples
          ruby scripts/convert_heic.rb

      - name: Commit HEIC conversions
        id: commit_heic
        shell: bash
        run: |
          set -euo pipefail
          committed=false
          if git diff --quiet; then
            echo "No HEIC-related changes to commit."
          else
            git pull --rebase origin main
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "Convert HEIC images to JPEG"
            git push origin HEAD:main
            committed=true
          fi
          echo "committed=${committed}" >> "$GITHUB_OUTPUT"

      - name: Refresh checkout after HEIC commit
        if: steps.commit_heic.outputs.committed == 'true'
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          clean: true

      - name: Collect changed images
        shell: bash
        run: |
          set -euo pipefail
          list="$RUNNER_TEMP/changed-images.txt"
          : > "$list"
          before="${{ github.event.before }}"
          after="$(git rev-parse HEAD)"
          if [[ -z "$before" || "$before" =~ ^0+$ ]] || ! git cat-file -e "${before}^{commit}" 2>/dev/null; then
            git ls-files -z > "$list"
          else
            git diff --name-only -z "$before" "$after" > "$list"
          fi

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Sharp
        shell: bash
        run: |
          set -euo pipefail
          npm install --prefix "$RUNNER_TEMP/sharp" sharp@0.33.5

      - name: Optimize images
        shell: bash
        env:
          NODE_PATH: ${{ runner.temp }}/sharp/node_modules
        run: |
          set -euo pipefail
          node scripts/optimize_images.js \
            --root assets/images \
            --max-width 1600 \
            --jpeg-quality 82 \
            --png-quality 82 \
            --webp-quality 82 \
            --ignore assets/images/favicon \
            --file-list "$RUNNER_TEMP/changed-images.txt"

      - name: Commit optimized images
        shell: bash
        run: |
          set -euo pipefail
          if git diff --quiet; then
            echo "No optimized images to commit."
            exit 0
          fi
          git pull --rebase origin main
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Optimize images"
          git push origin HEAD:main
